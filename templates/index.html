<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlowPrint - Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <h1>FlowPrint</h1>
            </div>
            <div class="header-actions">
                <button id="themeToggle" class="btn btn-icon" onclick="toggleTheme()" title="Toggle theme">
                    <span class="theme-icon">üåô</span>
                </button>
                <button id="manualCheckBtn" class="btn btn-secondary" onclick="manualCheck()" title="Manually check inbox now">
                    üîÑ Check Now
                </button>
                <button id="startBtn" class="btn btn-success" onclick="startService()">
                    <span class="icon">‚ñ∂</span> Start
                </button>
                <button id="stopBtn" class="btn btn-danger" onclick="stopService()" disabled>
                    <span class="icon">‚ñ†</span> Stop
                </button>
            </div>
        </header>

        <!-- Status Banner - Slimmer Design -->
        <div id="statusBanner" class="status-banner status-stopped">
            <div class="status-main">
                <span class="status-dot"></span>
                <span id="statusText">Service Stopped</span>
            </div>
            <div class="status-time">
                <span id="nextCheckDisplay">--:--:--</span>
            </div>
            <div class="countdown-mini" id="countdownMini" style="display: none;">
                <span id="countdownTime">--</span>
                <div class="countdown-progress-mini">
                    <div id="countdownBar" class="countdown-bar-mini"></div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="content">
            <!-- Left Column: Configuration -->
            <div class="config-panel">
                <div class="card">
                    <div class="card-header">
                        <h2>‚öôÔ∏è Configuration</h2>
                        <div class="header-buttons">
                            <button class="btn btn-small btn-secondary" onclick="window.open('https://github.com/NotDonaldTrump/FlowPrint#readme', '_blank')">
                                üìö Docs
                            </button>
                            <button class="btn btn-small btn-primary" onclick="saveConfig()">
                                üíæ Save
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="tabs">
                            <button class="tab-btn active" onclick="switchTab('email')">üìß Email</button>
                            <button class="tab-btn" onclick="switchTab('behavior')">üîß Behavior</button>
                            <button class="tab-btn" onclick="switchTab('advanced')">‚öôÔ∏è Advanced</button>
                            <button class="tab-btn" onclick="switchTab('webhook')">üîó Webhook</button>
                            <button class="tab-btn" onclick="switchTab('templates')">üìÑ Templates</button>
                        </div>

                        <!-- Email Settings Tab -->
                        <div id="emailTab" class="tab-content active">
                            <div class="form-group">
                                <label for="imapHost">IMAP Server</label>
                                <input type="text" id="imapHost" placeholder="imap.gmail.com">
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="imapPort">Port</label>
                                    <input type="number" id="imapPort" value="993">
                                </div>
                                <div class="form-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="imapUseSsl" checked>
                                        Use SSL
                                    </label>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="imapUsername">Email Address</label>
                                <input type="email" id="imapUsername" placeholder="your-email@example.com">
                            </div>

                            <div class="form-group">
                                <label for="imapPassword">Password / App Password</label>
                                <input type="password" id="imapPassword" placeholder="Enter password">
                                <small>For Gmail, use an App Password</small>
                            </div>

                            <div class="form-group">
                                <label for="mailbox">Mailbox Folder</label>
                                <input type="text" id="mailbox" value="Inbox">
                            </div>

                            <button class="btn btn-secondary btn-full" onclick="testConnection()">
                                üîå Test Connection
                            </button>
                        </div>

                        <!-- Behavior Settings Tab -->
                        <div id="behaviorTab" class="tab-content">

                            <div class="info-banner info-blue">
                                <h3>üì° Operation Mode</h3>
                                <p>Choose how FlowPrint should receive print jobs</p>
                            </div>

                            <div class="form-group">
                                <label for="operationMode">Print Job Source</label>
                                <select id="operationMode" class="mode-selector">
                                    <option value="email_only">üìß Email Only</option>
                                    <option value="webhook_only">üîó Webhook Only (Recommended)</option>
                                    <option value="email_primary">üìß Email Primary ‚Üí üîó Webhook Backup</option>
                                    <option value="webhook_primary">üîó Webhook Primary ‚Üí üìß Email Backup</option>
                                </select>
                                <small>
                                    <strong>Email Only:</strong> Monitor email for print jobs<br>
                                    <strong>Webhook Only:</strong> Receive jobs via Shopify webhook (faster, more secure)<br>
                                    <strong>Primary/Backup:</strong> If primary fails, automatically use backup method
                                </small>
                            </div>

                            <hr style="margin: 20px 0; border: none; border-top: 1px solid var(--border-color);">

                            <h3 style="margin-bottom: 10px;">Email Settings</h3>
                            <div class="form-group" id="subjectPrefixGroup">
                                <label for="subjectPrefix">Subject Filter Prefix</label>
                                <input type="text" id="subjectPrefix" value="[PRINT PACK]">
                            </div>

                            <div class="form-group" id="pollIntervalGroup">
                                <label for="pollInterval">Check Interval (seconds)</label>
                                <input type="number" id="pollInterval" value="30" min="5" max="600">
                            </div>

                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="autoPrint" checked>
                                    <span><strong>Auto-Print Mode</strong></span>
                                </label>
                            </div>

                            <div class="form-group warning-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="deleteAfterPrint">
                                    <span><strong>‚ö†Ô∏è Delete Email After Print</strong></span>
                                </label>
                            </div>
                        </div>

                        <!-- Advanced Settings Tab -->
                        <div id="advancedTab" class="tab-content">
                            <div class="form-group">
                                <label for="chromePath">Chrome Path (optional)</label>
                                <input type="text" id="chromePath" placeholder="Auto-detect">
                            </div>

                            <div class="form-group">
                                <label for="chromeWait">Print Wait Time (seconds)</label>
                                <input type="number" id="chromeWait" value="8" min="3" max="30">
                            </div>

                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="cleanupEnabled" checked>
                                    <span><strong>Auto-Cleanup Temp Files</strong></span>
                                </label>
                            </div>

                            <div class="form-group" id="cleanupHoursGroup">
                                <label for="cleanupHours">Cleanup After (hours)</label>
                                <input type="number" id="cleanupHours" value="6" min="1" max="168">
                                <small>Files older than this will be auto-deleted</small>
                            </div>

                            <button class="btn btn-danger btn-full" onclick="clearCache()">
                                üóëÔ∏è Clear Temp Files Now
                            </button>

                            <hr style="margin: 30px 0; border: none; border-top: 1px solid var(--border-color);">

                            <h3 style="margin-bottom: 15px;">üîê Security</h3>

                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="authEnabled">
                                    <span><strong>Enable Password Protection</strong></span>
                                </label>
                                <small>Require login to access the dashboard</small>
                            </div>

                            <div class="form-group" id="authUsernameGroup" style="display: none;">
                                <label for="authUsername">Username</label>
                                <input type="text" id="authUsername" value="admin">
                            </div>

                            <div class="form-group" id="authPasswordGroup" style="display: none;">
                                <label for="authPassword">Password</label>
                                <input type="password" id="authPassword" placeholder="Set a password">
                                <small>‚ö†Ô∏è Remember this password! You will need it to log in.</small>
                            </div>

                            <div class="form-group" style="display: none;" id="logoutGroup">
                                <button class="btn btn-secondary btn-full" onclick="window.location.href='/logout'">üö™ Logout</button>
                            </div>

                            <hr style="margin: 30px 0; border: none; border-top: 1px solid var(--border-color);">

                            <div class="form-group">
                                <button class="btn btn-reset btn-full" onclick="resetToDefaults()">üîÑ Reset All Settings to Default</button>
                                <small>‚ö†Ô∏è This will require admin password and reset ALL settings</small>
                            </div>

                            <div class="form-group">
                                <button class="btn btn-secondary btn-full" onclick="downloadLogs()">üíæ Save System Logs</button>
                                <small>Download activity logs and system information</small>
                            </div>
                        </div>

                        <!-- Webhook Settings Tab -->
                        <div id="webhookTab" class="tab-content">
                            <div class="info-banner info-blue">
                                <h3>‚ÑπÔ∏è How Webhooks Work</h3>
                                <p>Webhooks allow Shopify to instantly send order data to FlowPrint (instead of email polling).</p>
                                <ul>
                                    <li><strong>Faster:</strong> 1-3 seconds vs 10-30 seconds</li>
                                    <li><strong>More Reliable:</strong> Direct HTTP connection</li>
                                    <li><strong>No Email Required:</strong> Works without email account</li>
                                </ul>
                            </div>

                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="webhookEnabled">
                                    <span><strong>Enable Webhook Receiver</strong></span>
                                </label>
                                <small>Turn this on after configuring Shopify webhooks</small>
                            </div>

                            <div class="form-group">
                                <label for="webhookSecret">Webhook Secret</label>
                                <input type="password" id="webhookSecret" placeholder="Get this from Shopify Admin">
                                <small>Find in: <strong>Shopify Admin ‚Üí Settings ‚Üí Notifications ‚Üí Webhooks</strong></small>
                            </div>

                            <div class="form-group">
                                <label for="webhookTemplate">Template to Use</label>
                                <select id="webhookTemplate">
                                    <option value="default_packing_slip.html">Default Packing Slip</option>
                                </select>
                                <small>Choose which template to use for printing orders</small>
                            </div>


                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="webhookAutoPrint" checked>
                                    <span><strong>Auto-Print Mode</strong></span>
                                </label>
                                <small>If unchecked, Chrome will open with the print dialog (manual mode)</small>
                            </div>

                            <div class="form-group">
                                <label for="webhookPrintWaitSeconds">Print Wait Time (seconds)</label>
                                <input type="number" id="webhookPrintWaitSeconds" value="8" min="3" max="30">
                                <small>How long to wait before closing Chrome (auto-print mode only)</small>
                            </div>
                            <div class="info-panel">
                                <h3>üìã Shopify Setup Instructions</h3>
                                
                                <div class="setup-step">
                                    <h4>Step 1: Get Your Webhook URL</h4>
                                    <div class="input-copy-group">
                                        <input type="text" id="webhookUrl" readonly 
                                               value="http://your-ip:5000/api/webhook/shopify"
                                               style="font-family: monospace;">
                                        <button onclick="copyWebhookUrl()" class="btn btn-secondary">üìã Copy</button>
                                    </div>
                                    <small>‚ö†Ô∏è <strong>Important:</strong> Replace "your-ip" with your public IP or use ngrok</small>
                                </div>

                                <div class="setup-step">
                                    <h4>Step 2: Create Webhook in Shopify</h4>
                                    <ol>
                                        <li>Go to <strong>Shopify Admin ‚Üí Settings ‚Üí Notifications</strong></li>
                                        <li>Scroll to <strong>Webhooks</strong> section</li>
                                        <li>Click <strong>"Create webhook"</strong></li>
                                        <li><strong>Event:</strong> Order creation</li>
                                        <li><strong>Format:</strong> JSON</li>
                                        <li><strong>URL:</strong> Paste your webhook URL</li>
                                        <li><strong>Copy the secret</strong> and paste it above</li>
                                    </ol>
                                </div>

                                <div class="setup-step">
                                    <h4>Step 3: Test Connection</h4>
                                    <button onclick="testWebhook()" class="btn btn-primary">
                                        üß™ Send Test Print
                                    </button>
                                    <small>This will print a sample order to verify everything works</small>
                                </div>
                            </div>
                        </div>

                        <!-- Templates Tab -->
                        <div id="templatesTab" class="tab-content">
                            <div class="info-banner info-orange">
                                <h3>‚úèÔ∏è Template Editor</h3>
                                <p>Create and edit HTML templates for printing orders. Templates use Jinja2 syntax (similar to Shopify Liquid).</p>
                                <p><strong>Available Variables:</strong> <code>order</code>, <code>now</code>, <code>format_currency</code>, <code>format_date</code></p>
                            </div>

                            <div class="template-controls">
                                <div class="form-group" style="flex: 1;">
                                    <label for="templateSelector">Select Template</label>
                                    <select id="templateSelector" onchange="loadTemplate()">
                                        <option value="">-- Select Template --</option>
                                    </select>
                                </div>
                                
                                <div style="display: flex; gap: 10px; align-items: end;">
                                    <button onclick="createNewTemplate()" class="btn btn-secondary">‚ûï New</button>
                                    <button onclick="deleteTemplate()" class="btn btn-danger">üóëÔ∏è Delete</button>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="templateName">Template Name</label>
                                <input type="text" id="templateName" placeholder="e.g., order_packing_slip.html">
                            </div>

                            <div class="form-group">
                                <label for="templateContent">Template HTML</label>
                                <textarea id="templateContent" 
                                          style="font-family: 'Courier New', monospace; min-height: 400px; width: 100%;"
                                          placeholder="Enter your HTML template here..."></textarea>
                                <small>
                                    <strong>Quick Reference:</strong><br>
                                    {% raw %}
                                    ‚Ä¢ Access data: <code>{{ order.name }}</code>, <code>{{ order.customer.email }}</code><br>
                                    ‚Ä¢ Loop items: <code>{% for item in order.line_items %} ... {% endfor %}</code><br>
                                    ‚Ä¢ Conditionals: <code>{% if order.note %} ... {% endif %}</code>
                                
                                    {% endraw %}</small>
                            </div>

                            <div class="template-actions">
                                <button onclick="previewTemplate()" class="btn btn-secondary">üëÅÔ∏è Preview</button>
                                <button onclick="testPrintTemplate()" class="btn btn-secondary">üñ®Ô∏è Test Print</button>
                                <button onclick="saveTemplate()" class="btn btn-primary">üíæ Save Template</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Status & Monitoring -->
            <div class="monitor-panel">
                <!-- Statistics Card -->
                <div class="card">
                    <div class="card-header">
                        <h2>üìä Statistics</h2>
                    </div>
                    <div class="card-body">
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-value" id="messagesFound">0</div>
                                <div class="stat-label">Messages</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="jobsProcessed">0</div>
                                <div class="stat-label">Processed</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="jobsPending">0</div>
                                <div class="stat-label">Pending</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Jobs Card -->
                <div class="card">
                    <div class="card-header">
                        <h2>üìã Recent Jobs</h2>
                    </div>
                    <div class="card-body">
                        <div id="recentJobs" class="jobs-list">
                            <div class="empty-state">No jobs yet</div>
                        </div>
                    </div>
                </div>

                <!-- Errors Card -->
                <div class="card" id="errorsCard" style="display: none;">
                    <div class="card-header">
                        <h2>‚ö†Ô∏è Errors</h2>
                    </div>
                    <div class="card-body">
                        <div id="recentErrors" class="errors-list"></div>
                    </div>
                </div>

                <!-- Activity Log Card -->
                <div class="card">
                    <div class="card-header">
                        <h2>üìù Activity Log</h2>
                        <button class="btn btn-small btn-secondary" onclick="refreshLogs()">
                            üîÑ Refresh
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="activityLog" class="log-viewer">
                            <div class="empty-state">Loading...</div>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <div class="footer">
                    <p>
                        <a href="https://github.com/NotDonaldTrump/FlowPrint" target="_blank">GitHub</a> ‚Ä¢ 
                        <a href="https://github.com/NotDonaldTrump/FlowPrint#readme" target="_blank">Documentation</a> ‚Ä¢ 
                        <a href="https://github.com/NotDonaldTrump/FlowPrint/issues" target="_blank">Report Issue</a>
                    </p>
                    <p class="disclaimer">No direct support provided. Please use GitHub Issues for assistance.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    <script>
// Webhook Functions
function copyWebhookUrl() {
    const urlInput = document.getElementById('webhookUrl');
    urlInput.select();
    document.execCommand('copy');
    showToast('Webhook URL copied!', 'success');
}

function testWebhook() {
    showToast('Sending test print...', 'info');
    fetch('/api/webhook/test', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Test print sent! Check your printer.', 'success');
        } else {
            showToast('Test failed: ' + data.error, 'error');
        }
    })
    .catch(error => showToast('Error: ' + error, 'error'));
}

// Template Functions
let currentTemplates = [];

function loadTemplatesList() {
    fetch('/api/templates')
        .then(response => response.json())
        .then(data => {
            currentTemplates = data.templates;
            const selector = document.getElementById('templateSelector');
            const webhookSelector = document.getElementById('webhookTemplate');
            selector.innerHTML = '<option value="">-- Select Template --</option>';
            webhookSelector.innerHTML = '';
            data.templates.forEach(template => {
                selector.add(new Option(template, template));
                webhookSelector.add(new Option(template, template));
            });
        })
        .catch(error => showToast('Error loading templates', 'error'));
}

function loadTemplate() {
    const templateName = document.getElementById('templateSelector').value;
    if (!templateName) return;
    fetch('/api/templates/' + templateName)
        .then(response => response.json())
        .then(data => {
            document.getElementById('templateName').value = data.name;
            document.getElementById('templateContent').value = data.content;
        })
        .catch(error => showToast('Error loading template: ' + error, 'error'));
}

function saveTemplate() {
    const name = document.getElementById('templateName').value;
    const content = document.getElementById('templateContent').value;
    if (!name || !content) {
        showToast('Please enter template name and content', 'error');
        return;
    }
    fetch('/api/templates/' + name, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ content: content })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Template saved!', 'success');
            loadTemplatesList();
        } else {
            showToast('Error: ' + data.error, 'error');
        }
    })
    .catch(error => showToast('Error: ' + error, 'error'));
}

function createNewTemplate() {
    document.getElementById('templateSelector').value = '';
    document.getElementById('templateName').value = '';
    document.getElementById('templateContent').value = '';
    showToast('Enter template name and HTML', 'info');
}

function deleteTemplate() {
    const name = document.getElementById('templateSelector').value;
    if (!name) {
        showToast('Please select a template', 'error');
        return;
    }
    if (confirm('Delete ' + name + '?')) {
        showToast('Delete functionality coming soon', 'info');
    }
}

function testPrintTemplate() {
    testWebhook();
}

function previewTemplate() {
    const content = document.getElementById('templateContent').value;
    if (!content) {
        showToast('No template content', 'error');
        return;
    }
    const preview = window.open('', '_blank');
    preview.document.write(content);
    preview.document.close();
}

document.addEventListener('DOMContentLoaded', function() {
    loadTemplatesList();
});

</script>

</body>
</html>